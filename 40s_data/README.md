
`processor_batch_40s.py` 是一个支持批量处理多人员数据的HRV特征计算脚本，基于40秒数据段进行智能处理。

## 输入格式
脚本支持以下批量输入格式：

```
1人名
情绪标签1 对应分数
情绪标签2 对应分数
2人名
情绪标签1 对应分数
...
```

### 示例输入
```
1谭怡雅
平静
愉悦 6
愉悦 7
愉悦 8
2唐铭遥
紧张 9
愉悦 7
平静 5
3黄艳丽
愉悦 7
愉悦
平静 4
愉悦 7
```

## 使用方法

### 1. 准备数据
确保 `processed_data` 目录下有已划分好的CSV文件，文件名应包含人员姓名以便自动匹配。

### 2. 运行脚本
```bash
python multi_thread_hrv_processor_batch_40s.py
```

### 3. 输入数据
按提示输入批量数据，格式如上所示。输入完成后按 `Ctrl+Z` 然后回车结束。

### 4. 自动处理
脚本会自动：
- 根据人名匹配对应的CSV文件
- 对每个CSV文件进行峰值检测
- 使用滑动窗口生成40s高质量数据段
- 对每个数据段计算HRV特征
- 多线程并行处理所有文件

## 输出结果

### 1. HRV特征数据集
- 文件名：`hrv_data_batch_40s.csv`
- 格式：包含7个HRV特征 + 文件名 + 情绪标签
- 特征：RMSSD, pNN58, SDNN, SD1, SD2, SD1_SD2, SampEn

### 2. RR间隔数据备份
- 位置：`40sdata/backup_batch/`
- 按情绪标签分类存储
- 文件名格式：`原文件名_seg序号_RR_40s.csv`

## 配置参数

### 主要配置
- `INPUT_DATA_DIR`: 输入数据目录
- `OUTPUT_FILE`: 输出文件名
- `RR_BACKUP_BASE_DIR`: RR数据备份目录
- `MAX_WORKERS`: 最大线程数（建议CPU核心数的1-2倍）

### 数据段处理参数
- `SEGMENT_DURATION_MS`: 数据段长度（40000毫秒 = 40秒）
- `PEAK_DETECTION_PARAMS`: 峰值检测参数
- `QUALITY_PARAMS`: 质量评估参数

## 文件匹配规则
脚本使用简单的包含匹配规则：
- 如果CSV文件名包含人员姓名，则认为是该人员的文件
- 按文件名排序进行匹配
- 如果文件数量与情绪标签数量不匹配，会显示警告并处理匹配的部分

## 注意事项
1. 确保CSV文件格式正确（至少2列：时间和数值）
2. 文件名应包含人员姓名以便自动匹配
3. 情绪标签可以包含分数信息（如"愉悦 6"）
4. 脚本会自动处理文件数量与标签数量不匹配的情况
5. 处理过程中可以按 `Ctrl+C` 停止实时监控

## 错误处理
- 文件格式错误：跳过并显示错误信息
- 数据不足：跳过并显示警告
- 峰值检测失败：跳过并显示错误
- 无高质量数据段：跳过并显示警告
- 文件-标签数量不匹配：显示警告并处理匹配部分

## 性能优化
- 使用多线程并行处理
- 向量化计算HRV特征
- 智能数据段筛选
- 实时状态监控
- 批量状态更新减少锁操作

## 输出示例
```
=== 处理完成 ===
总文件数: 12
成功处理: 10
失败文件: 2
处理时间: 45.67 秒

📋 详细处理结果:
✅ 成功: 10 个文件
❌ 失败: 2 个文件
  - 格式错误: 1 个文件
  - 数据不足: 1 个文件
```
